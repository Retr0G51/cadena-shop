{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "pip install -r requirements.txt",
    "watchPatterns": [
      "app/**",
      "*.py",
      "requirements.txt"
    ]
  },
  "deploy": {
    "startCommand": "gunicorn wsgi:app --bind 0.0.0.0:$PORT --workers 4 --threads 2 --worker-class gevent --timeout 120 --keep-alive 5 --log-level info --access-logfile - --error-logfile -",
    "healthcheckPath": "/health",
    "healthcheckTimeout": 30,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 3
  },
  "services": [
    {
      "name": "pedidossaas",
      "icon": "üõí",
      "source": {
        "repo": "."
      },
      "variables": {
        "FLASK_ENV": "production",
        "FLASK_APP": "wsgi:app",
        "SECRET_KEY": {
          "generate": "string",
          "length": 32
        },
        "DATABASE_URL": {
          "fromService": "postgres"
        },
        "REDIS_URL": {
          "fromService": "redis"
        }
      }
    },
    {
      "name": "postgres",
      "icon": "üêò",
      "image": "postgres:15-alpine",
      "volumes": [
        {
          "mountPath": "/var/lib/postgresql/data",
          "name": "postgres-data"
        }
      ],
      "variables": {
        "POSTGRES_DB": "pedidossaas",
        "POSTGRES_USER": "pedidossaas_user",
        "POSTGRES_PASSWORD": {
          "generate": "string",
          "length": 24
        }
      }
    },
    {
      "name": "redis",
      "icon": "üî¥",
      "image": "redis:7-alpine",
      "volumes": [
        {
          "mountPath": "/data",
          "name": "redis-data"
        }
      ]
    },
    {
      "name": "worker",
      "icon": "‚öôÔ∏è",
      "source": {
        "repo": "."
      },
      "startCommand": "celery -A app.celery worker --loglevel=info --concurrency=2",
      "variables": {
        "DATABASE_URL": {
          "fromService": "postgres"
        },
        "REDIS_URL": {
          "fromService": "redis"
        }
      }
    },
    {
      "name": "scheduler",
      "icon": "‚è∞",
      "source": {
        "repo": "."
      },
      "startCommand": "celery -A app.celery beat --loglevel=info",
      "variables": {
        "DATABASE_URL": {
          "fromService": "postgres"
        },
        "REDIS_URL": {
          "fromService": "redis"
        }
      }
    }
  ],
  "environments": {
    "production": {
      "variables": {
        "FLASK_ENV": "production",
        "LOG_LEVEL": "INFO",
        "WEB_CONCURRENCY": "4"
      }
    },
    "staging": {
      "variables": {
        "FLASK_ENV": "production",
        "LOG_LEVEL": "DEBUG",
        "WEB_CONCURRENCY": "2"
      }
    }
  }
}
