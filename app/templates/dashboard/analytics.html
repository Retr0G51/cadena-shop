{% extends "base.html" %}

{% block title %}Analytics - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Analytics del Negocio</h1>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary" onclick="changeDateRange('today')">Hoy</button>
                    <button type="button" class="btn btn-outline-secondary" onclick="changeDateRange('week')">7 días</button>
                    <button type="button" class="btn btn-outline-secondary active" onclick="changeDateRange('month')">30 días</button>
                    <button type="button" class="btn btn-outline-secondary" onclick="changeDateRange('quarter')">90 días</button>
                </div>
            </div>

            <!-- Métricas principales -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-muted">Ventas Totales</h5>
                            <h2 class="text-success">${{ "{:,.2f}".format(metrics.total_sales) }}</h2>
                            <p class="mb-0">
                                <span class="{% if metrics.sales_change > 0 %}text-success{% else %}text-danger{% endif %}">
                                    <i class="fas fa-arrow-{% if metrics.sales_change > 0 %}up{% else %}down{% endif %}"></i>
                                    {{ "{:.1f}".format(metrics.sales_change|abs) }}%
                                </span>
                                vs período anterior
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-muted">Pedidos</h5>
                            <h2>{{ metrics.total_orders }}</h2>
                            <p class="mb-0">
                                <span class="text-info">{{ metrics.completed_orders }}</span> completados
                                ({{ "{:.0f}".format(metrics.completion_rate) }}%)
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-muted">Ticket Promedio</h5>
                            <h2>${{ "{:.2f}".format(metrics.avg_order_value) }}</h2>
                            <p class="mb-0">Por pedido completado</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-muted">Clientes Únicos</h5>
                            <h2>{{ metrics.unique_customers }}</h2>
                            <p class="mb-0">En el período</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráficos -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Tendencia de Ventas</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="salesTrendChart" height="100"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Ventas por Hora</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="hourlyChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Productos más vendidos -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Top 10 Productos</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Producto</th>
                                            <th class="text-center">Cantidad</th>
                                            <th class="text-right">Ingresos</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for product in top_products %}
                                        <tr>
                                            <td>{{ product.name }}</td>
                                            <td class="text-center">{{ product.quantity_sold }}</td>
                                            <td class="text-right">${{ "{:.2f}".format(product.revenue) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Análisis de Clientes</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center mb-3">
                                <div class="col-4">
                                    <h4>{{ customer_analytics.total_customers }}</h4>
                                    <small class="text-muted">Total</small>
                                </div>
                                <div class="col-4">
                                    <h4>{{ customer_analytics.new_customers }}</h4>
                                    <small class="text-muted">Nuevos (30d)</small>
                                </div>
                                <div class="col-4">
                                    <h4>{{ "{:.1f}".format(customer_analytics.retention_rate) }}%</h4>
                                    <small class="text-muted">Retención</small>
                                </div>
                            </div>
                            <canvas id="customerSegmentChart" height="150"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Acciones rápidas -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Exportar Datos</h5>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('dashboard.export_analytics', type='full', format='csv') }}" 
                                   class="btn btn-outline-primary">
                                    <i class="fas fa-file-csv"></i> Exportar CSV
                                </a>
                                <a href="{{ url_for('dashboard.export_analytics', type='full', format='json') }}" 
                                   class="btn btn-outline-primary">
                                    <i class="fas fa-file-code"></i> Exportar JSON
                                </a>
                                <button onclick="window.print()" class="btn btn-outline-primary">
                                    <i class="fas fa-print"></i> Imprimir Reporte
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Datos para los gráficos
const salesTrendData = {{ sales_trend | tojson }};
const hourlyData = {{ hourly_sales | tojson }};
const customerSegments = {{ customer_analytics.segments | tojson }};

// Gráfico de tendencia de ventas
const salesCtx = document.getElementById('salesTrendChart').getContext('2d');
new Chart(salesCtx, {
    type: 'line',
    data: {
        labels: salesTrendData.map(d => new Date(d.date).toLocaleDateString()),
        datasets: [{
            label: 'Ingresos',
            data: salesTrendData.map(d => d.revenue),
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            tension: 0.1
        }, {
            label: 'Pedidos',
            data: salesTrendData.map(d => d.orders),
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            yAxisID: 'y1',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                ticks: {
                    callback: function(value) {
                        return '$' + value.toFixed(0);
                    }
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                grid: {
                    drawOnChartArea: false,
                }
            }
        }
    }
});

// Gráfico de ventas por hora
const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
new Chart(hourlyCtx, {
    type: 'bar',
    data: {
        labels: hourlyData.map(d => d.hour + ':00'),
        datasets: [{
            label: 'Pedidos',
            data: hourlyData.map(d => d.orders),
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Gráfico de segmentos de clientes
const segmentCtx = document.getElementById('customerSegmentChart').getContext('2d');
new Chart(segmentCtx, {
    type: 'doughnut',
    data: {
        labels: customerSegments.map(s => s.name),
        datasets: [{
            data: customerSegments.map(s => s.count),
            backgroundColor: [
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
            }
        }
    }
});

// Función para cambiar rango de fechas
function changeDateRange(range) {
    let dateFrom, dateTo = new Date();
    
    switch(range) {
        case 'today':
            dateFrom = new Date();
            break;
        case 'week':
            dateFrom = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            break;
        case 'month':
            dateFrom = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
            break;
        case 'quarter':
            dateFrom = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000);
            break;
    }
    
    const params = new URLSearchParams({
        date_from: dateFrom.toISOString().split('T')[0],
        date_to: dateTo.toISOString().split('T')[0]
    });
    
    window.location.href = `{{ url_for('dashboard.analytics') }}?${params.toString()}`;
}
</script>

<style>
@media print {
    .btn-group, .navbar, .sidebar { display: none !important; }
    .card { break-inside: avoid; }
}
</style>
{% endblock %}
