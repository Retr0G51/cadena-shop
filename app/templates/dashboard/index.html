{% extends "dashboard/base_with_sidebar.html" %}

{% block title %}Dashboard - {{ current_user.business_name }}{% endblock %}

{% block extra_css %}
<style>
    /* ==================== ESTILOS S√öPER PRO ==================== */
    .metric-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid rgba(0,0,0,0.05);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #667eea, #764ba2);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
    
    .metric-card:hover::before {
        opacity: 1;
    }
    
    .metric-number {
        font-size: 2.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        line-height: 1;
    }
    
    .growth-indicator {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    
    .growth-positive {
        background: rgba(16, 185, 129, 0.1);
        color: #059669;
    }
    
    .growth-negative {
        background: rgba(239, 68, 68, 0.1);
        color: #dc2626;
    }
    
    .growth-neutral {
        background: rgba(107, 114, 128, 0.1);
        color: #6b7280;
    }
    
    .chart-container {
        position: relative;
        height: 350px;
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    
    .activity-timeline {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 8px;
    }
    
    .activity-item {
        display: flex;
        align-items: start;
        gap: 16px;
        padding: 16px;
        border-radius: 12px;
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
        margin-bottom: 8px;
    }
    
    .activity-item:hover {
        background: #f8fafc;
        border-left-color: #8b5cf6;
        transform: translateX(4px);
    }
    
    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 16px;
    }
    
    .progress-ring {
        width: 120px;
        height: 120px;
        position: relative;
    }
    
    .progress-ring svg {
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
    }
    
    .progress-ring circle {
        fill: transparent;
        stroke-width: 8;
        r: 50;
        cx: 60;
        cy: 60;
    }
    
    .progress-background {
        stroke: #e5e7eb;
    }
    
    .progress-bar {
        stroke: url(#gradient);
        stroke-linecap: round;
        stroke-dasharray: 314;
        stroke-dashoffset: 314;
        transition: stroke-dashoffset 1s ease-in-out;
    }
    
    .alert-card {
        background: white;
        border-radius: 12px;
        border-left: 4px solid;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        margin-bottom: 12px;
        transition: all 0.3s ease;
    }
    
    .alert-warning { border-left-color: #f59e0b; }
    .alert-info { border-left-color: #3b82f6; }
    .alert-success { border-left-color: #10b981; }
    .alert-error { border-left-color: #ef4444; }
    
    .alert-card:hover {
        transform: translateX(4px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    
    .quick-action-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 12px;
        padding: 16px 20px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 12px;
        text-decoration: none;
        width: 100%;
        justify-content: space-between;
    }
    
    .quick-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        color: white;
        text-decoration: none;
    }
    
    .notification-badge {
        background: #ef4444;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        position: absolute;
        top: -8px;
        right: -8px;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    
    .product-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-radius: 8px;
        transition: background 0.2s ease;
    }
    
    .product-item:hover {
        background: #f8fafc;
    }
    
    .product-avatar {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        object-fit: cover;
        background: #f3f4f6;
    }
    
    .copy-btn {
        transition: all 0.3s ease;
    }
    
    .copy-btn.copied {
        background: #10b981 !important;
        transform: scale(1.05);
    }
    
    /* Scrollbar personalizada */
    .activity-timeline::-webkit-scrollbar {
        width: 6px;
    }
    
    .activity-timeline::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }
    
    .activity-timeline::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }
    
    .activity-timeline::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- ==================== HEADER DIN√ÅMICO ==================== -->
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8">
        <div>
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                {% set hour = moment().hour if moment else 12 %}
                {% if hour < 12 %}
                    üåÖ ¬°Buenos d√≠as, {{ current_user.business_name.split()[0] if current_user.business_name else 'Emprendedor' }}!
                {% elif hour < 18 %}
                    ‚òÄÔ∏è ¬°Buenas tardes, {{ current_user.business_name.split()[0] if current_user.business_name else 'Emprendedor' }}!
                {% else %}
                    üåô ¬°Buenas noches, {{ current_user.business_name.split()[0] if current_user.business_name else 'Emprendedor' }}!
                {% endif %}
            </h1>
            <p class="text-xl text-gray-600">As√≠ van las cosas en {{ current_user.business_name or 'tu negocio' }} hoy</p>
        </div>
        
        <!-- Acciones r√°pidas del header -->
        <div class="flex gap-3 mt-6 lg:mt-0">
            <a href="{{ url_for('public.store', slug=current_user.slug) }}" target="_blank" 
               class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-medium hover:shadow-lg transition-all duration-300 flex items-center gap-2">
                <i class="fas fa-external-link-alt"></i>
                Ver Tienda
            </a>
            <a href="{{ url_for('dashboard.new_product') }}" 
               class="px-6 py-3 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-xl font-medium hover:shadow-lg transition-all duration-300 flex items-center gap-2">
                <i class="fas fa-plus"></i>
                Nuevo Producto
            </a>
        </div>
    </div>

    <!-- ==================== ALERTAS INTELIGENTES ==================== -->
    {% if alerts %}
    <div class="mb-8">
        {% for alert in alerts %}
        <div class="alert-card alert-{{ alert.type }} p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    {% if alert.type == 'warning' %}
                    <i class="fas fa-exclamation-triangle text-yellow-500 text-xl"></i>
                    {% elif alert.type == 'info' %}
                    <i class="fas fa-info-circle text-blue-500 text-xl"></i>
                    {% elif alert.type == 'success' %}
                    <i class="fas fa-check-circle text-green-500 text-xl"></i>
                    {% else %}
                    <i class="fas fa-bell text-gray-500 text-xl"></i>
                    {% endif %}
                    <div>
                        <h4 class="font-semibold text-gray-800">{{ alert.title }}</h4>
                        <p class="text-gray-600 text-sm">{{ alert.message }}</p>
                    </div>
                </div>
                {% if alert.action_url %}
                <a href="{{ alert.action_url }}" class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition text-sm font-medium">
                    {{ alert.action_text }}
                </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- ==================== M√âTRICAS PRINCIPALES ==================== -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        
        <!-- Ventas de Hoy -->
        <div class="metric-card p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-green-100 rounded-full">
                    <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
                </div>
                <span class="growth-indicator {{ 'growth-positive' if today_growth > 0 else ('growth-negative' if today_growth < 0 else 'growth-neutral') }}">
                    {% if today_growth > 0 %}
                        <i class="fas fa-arrow-up"></i> +{{ today_growth }}%
                    {% elif today_growth < 0 %}
                        <i class="fas fa-arrow-down"></i> {{ today_growth }}%
                    {% else %}
                        <i class="fas fa-minus"></i> {{ today_growth }}%
                    {% endif %}
                </span>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-600 mb-1">Ventas Hoy</p>
                <p class="metric-number" data-metric="today_sales">${{ today_sales }}</p>
                <p class="text-xs text-gray-500 mt-2">vs ayer: ${{ yesterday_sales or 0 }}</p>
            </div>
        </div>

        <!-- Pedidos de Hoy -->
        <div class="metric-card p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-blue-100 rounded-full">
                    <i class="fas fa-shopping-cart text-blue-600 text-xl"></i>
                </div>
                {% if pending_orders > 0 %}
                <div class="relative">
                    <i class="fas fa-bell text-blue-600"></i>
                    <span class="notification-badge">{{ pending_orders }}</span>
                </div>
                {% endif %}
            </div>
            <div>
                <p class="text-sm font-medium text-gray-600 mb-1">Pedidos Hoy</p>
                <p class="metric-number" data-metric="today_orders">{{ today_orders }}</p>
                <p class="text-xs text-gray-500 mt-2">{{ pending_orders }} pendientes</p>
            </div>
        </div>

        <!-- Clientes -->
        <div class="metric-card p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-purple-100 rounded-full">
                    <i class="fas fa-users text-purple-600 text-xl"></i>
                </div>
                <span class="growth-indicator growth-positive">
                    <i class="fas fa-user-plus"></i> {{ new_customers }}
                </span>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-600 mb-1">Clientes Totales</p>
                <p class="metric-number">{{ customers_count }}</p>
                <p class="text-xs text-gray-500 mt-2">{{ new_customers }} nuevos esta semana</p>
            </div>
        </div>

        <!-- Productos -->
        <div class="metric-card p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-indigo-100 rounded-full">
                    <i class="fas fa-box text-indigo-600 text-xl"></i>
                </div>
                {% if low_stock_products > 0 %}
                <span class="growth-indicator growth-negative">
                    <i class="fas fa-exclamation-triangle"></i> {{ low_stock_products }}
                </span>
                {% else %}
                <span class="growth-indicator growth-positive">
                    <i class="fas fa-check"></i> OK
                </span>
                {% endif %}
            </div>
            <div>
                <p class="text-sm font-medium text-gray-600 mb-1">Productos Activos</p>
                <p class="metric-number">{{ active_products }}</p>
                <p class="text-xs text-gray-500 mt-2">{{ total_products }} total</p>
            </div>
        </div>
    </div>

    <!-- ==================== GR√ÅFICOS Y AN√ÅLISIS ==================== -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        
        <!-- Gr√°fico de Ventas -->
        <div class="chart-container">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">üìà Ventas √öltimos 7 D√≠as</h3>
                <div class="flex gap-2">
                    <button onclick="changeChartPeriod('7d')" class="chart-period-btn active px-3 py-1 text-sm bg-purple-100 text-purple-700 rounded-md font-medium">7D</button>
                    <button onclick="changeChartPeriod('30d')" class="chart-period-btn px-3 py-1 text-sm text-gray-600 hover:bg-gray-100 rounded-md font-medium">30D</button>
                </div>
            </div>
            <canvas id="salesChart"></canvas>
        </div>

        <!-- Productos M√°s Vendidos -->
        <div class="metric-card p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-6">üèÜ Productos M√°s Vendidos</h3>
            
            <div class="space-y-3">
                {% for product in top_products[:5] %}
                <div class="product-item">
                    {% if product.image %}
                    <img src="{{ url_for('static', filename='uploads/products/' + product.image) }}" 
                         alt="{{ product.name }}" class="product-avatar">
                    {% else %}
                    <div class="product-avatar flex items-center justify-center">
                        <i class="fas fa-image text-gray-400"></i>
                    </div>
                    {% endif %}
                    
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800">{{ product.name }}</h4>
                        <p class="text-sm text-gray-600">${{ product.price }}</p>
                    </div>
                    
                    <div class="text-right">
                        <div class="font-bold text-gray-800">{{ product.units_sold or 0 }}</div>
                        <div class="text-xs text-gray-500">vendidos</div>
                    </div>
                </div>
                {% endfor %}
                
                {% if not top_products %}
                <div class="text-center py-12">
                    <i class="fas fa-chart-bar text-gray-300 text-5xl mb-4"></i>
                    <p class="text-gray-500 text-lg">No hay datos de ventas a√∫n</p>
                    <p class="text-gray-400 text-sm">Los productos aparecer√°n aqu√≠ cuando tengas ventas</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ==================== ACTIVIDAD Y ACCIONES ==================== -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
        
        <!-- Actividad Reciente -->
        <div class="lg:col-span-2 metric-card p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">‚ö° Actividad Reciente</h3>
                <a href="{{ url_for('dashboard.orders') }}" class="text-purple-600 hover:text-purple-800 font-medium text-sm">
                    Ver todo ‚Üí
                </a>
            </div>
            
            <div class="activity-timeline">
                {% for activity in recent_activities %}
                <div class="activity-item">
                    <div class="activity-icon" style="background: {{ 'rgba(16, 185, 129, 0.1)' if activity.type == 'order' else 'rgba(59, 130, 246, 0.1)' }};">
                        <i class="{{ activity.icon }}"></i>
                    </div>
                    
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-1">
                            <h4 class="font-semibold text-gray-800">{{ activity.title }}</h4>
                            <span class="text-xs text-gray-500">{{ activity.time_ago }}</span>
                        </div>
                        <p class="text-gray-600 text-sm">{{ activity.description }}</p>
                        {% if activity.link and activity.link != '#' %}
                        <a href="{{ activity.link }}" class="text-purple-600 hover:text-purple-800 text-xs font-medium mt-1 inline-block">
                            Ver detalles ‚Üí
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                
                {% if not recent_activities %}
                <div class="text-center py-12">
                    <i class="fas fa-clock text-gray-300 text-5xl mb-4"></i>
                    <p class="text-gray-500 text-lg">No hay actividad reciente</p>
                    <p class="text-gray-400 text-sm">La actividad aparecer√° aqu√≠ cuando tengas pedidos</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Panel de Acciones y Meta -->
        <div class="space-y-6">
            
            <!-- Acciones R√°pidas -->
            <div class="metric-card p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">üöÄ Acciones R√°pidas</h3>
                
                <div class="space-y-3">
                    <a href="{{ url_for('dashboard.new_product') }}" class="quick-action-btn">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-plus-circle"></i>
                            <span>Agregar Producto</span>
                        </div>
                        <i class="fas fa-arrow-right"></i>
                    </a>
                    
                    <a href="{{ url_for('dashboard.orders') }}" class="quick-action-btn relative">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-list"></i>
                            <span>Gestionar Pedidos</span>
                        </div>
                        <div class="flex items-center gap-2">
                            {% if pending_orders > 0 %}
                            <span class="notification-badge position-static">{{ pending_orders }}</span>
                            {% endif %}
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </a>
                    
                    <a href="{{ url_for('dashboard.customers') }}" class="quick-action-btn">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-users"></i>
                            <span>Ver Clientes</span>
                        </div>
                        <i class="fas fa-arrow-right"></i>
                    </a>
                    
                    {% if 'dashboard.analytics' in url_map %}
                    <a href="{{ url_for('dashboard.analytics') }}" class="quick-action-btn">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-chart-line"></i>
                            <span>Analytics</span>
                        </div>
                        <i class="fas fa-arrow-right"></i>
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Meta Mensual -->
            <div class="metric-card p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">üéØ Meta del Mes</h3>
                
                <div class="flex items-center justify-center mb-4">
                    <div class="progress-ring">
                        <svg>
                            <defs>
                                <linearGradient id="gradient">
                                    <stop offset="0%" stop-color="#667eea"/>
                                    <stop offset="100%" stop-color="#764ba2"/>
                                </linearGradient>
                            </defs>
                            <circle class="progress-background"/>
                            <circle class="progress-bar" style="stroke-dashoffset: {{ 314 - (goal_progress * 314 / 100) }};"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-gray-800">{{ goal_progress }}%</div>
                                <div class="text-xs text-gray-600">completado</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mb-4">
                    <div class="text-sm text-gray-600 mb-1">Ventas del mes</div>
                    <div class="text-xl font-bold text-gray-800">${{ monthly_sales }} / ${{ monthly_goal }}</div>
                    <div class="text-xs text-gray-500 mt-1">
                        Faltan ${{ monthly_goal - monthly_sales }} para la meta
                    </div>
                </div>
                
                {% if monthly_growth > 0 %}
                <div class="text-center">
                    <span class="growth-indicator growth-positive">
                        <i class="fas fa-arrow-up"></i> +{{ monthly_growth }}% vs mes anterior
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ==================== M√âTRICAS ADICIONALES ==================== -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        
        <!-- Ticket Promedio -->
        <div class="metric-card p-6 text-center">
            <div class="p-3 bg-yellow-100 rounded-full inline-flex mb-4">
                <i class="fas fa-receipt text-yellow-600 text-xl"></i>
            </div>
            <div class="metric-number text-2xl">${{ avg_order_value }}</div>
            <p class="text-sm text-gray-600 mt-1">Ticket Promedio</p>
        </div>

        <!-- Tasa de Retenci√≥n -->
        <div class="metric-card p-6 text-center">
            <div class="p-3 bg-pink-100 rounded-full inline-flex mb-4">
                <i class="fas fa-sync text-pink-600 text-xl"></i>
            </div>
            <div class="metric-number text-2xl">{{ retention_rate }}%</div>
            <p class="text-sm text-gray-600 mt-1">Tasa de Retenci√≥n</p>
        </div>

        <!-- Conversi√≥n -->
        <div class="metric-card p-6 text-center">
            <div class="p-3 bg-teal-100 rounded-full inline-flex mb-4">
                <i class="fas fa-percentage text-teal-600 text-xl"></i>
            </div>
            <div class="metric-number text-2xl">{{ conversion_rate }}%</div>
            <p class="text-sm text-gray-600 mt-1">Tasa de Conversi√≥n</p>
        </div>
    </div>

    <!-- ==================== URL DE TIENDA ==================== -->
    <div class="metric-card p-6 mb-8">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-gray-800">üîó Tu URL de Tienda</h3>
            <span class="text-sm text-gray-500">{{ products_views }} vistas totales</span>
        </div>
        
        <div class="bg-gray-50 p-4 rounded-lg">
            <p class="text-sm text-gray-600 mb-3">Comparte este enlace con tus clientes para que puedan ver tu cat√°logo:</p>
            <div class="flex items-center gap-3">
                <input type="text" 
                       id="store-url"
                       value="{{ url_for('public.store', slug=current_user.slug, _external=True) }}" 
                       class="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-sm bg-white" 
                       readonly>
                <button onclick="copyStoreUrl()" 
                        id="copy-btn"
                        class="copy-btn px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium">
                    <i class="fas fa-copy mr-2"></i>
                    Copiar
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== √öLTIMOS PEDIDOS ==================== -->
    {% if recent_orders %}
    <div class="metric-card p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-800">üìã √öltimos Pedidos</h3>
            <a href="{{ url_for('dashboard.orders') }}" class="text-purple-600 hover:text-purple-800 font-medium">
                Ver todos ‚Üí
            </a>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr class="border-b">
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Pedido</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Cliente</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Total</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Estado</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Fecha</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in recent_orders %}
                    <tr class="border-b hover:bg-gray-50 transition">
                        <td class="py-3 px-4">
                            <span class="font-medium text-gray-800">#{{ order.id }}</span>
                        </td>
                        <td class="py-3 px-4">
                            <div>
                                <div class="font-medium text-gray-800">{{ order.customer_name or 'Cliente' }}</div>
                                <div class="text-sm text-gray-500">{{ order.customer_phone }}</div>
                            </div>
                        </td>
                        <td class="py-3 px-4">
                            <span class="font-semibold text-gray-800">${{ order.total }}</span>
                        </td>
                        <td class="py-3 px-4">
                            {% if order.status == 'pending' %}
                                <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium">
                                    Pendiente
                                </span>
                            {% elif order.status == 'confirmed' %}
                                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                                    Confirmado
                                </span>
                            {% elif order.status == 'processing' %}
                                <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium">
                                    Preparando
                                </span>
                            {% elif order.status == 'shipped' %}
                                <span class="px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-xs font-medium">
                                    Enviado
                                </span>
                            {% elif order.status == 'delivered' %}
                                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
                                    Entregado
                                </span>
                            {% elif order.status == 'cancelled' %}
                                <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">
                                    Cancelado
                                </span>
                            {% endif %}
                        </td>
                        <td class="py-3 px-4">
                            <span class="text-sm text-gray-600">{{ order.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                        </td>
                        <td class="py-3 px-4">
                            <a href="{{ url_for('dashboard.order_detail', order_id=order.id) }}" 
                               class="text-purple-600 hover:text-purple-800 font-medium text-sm">
                                Ver
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<!-- ==================== JAVASCRIPT S√öPER PRO ==================== -->
<script>
// Variables globales
let salesChart;
let currentPeriod = '7d';

// ==================== INICIALIZACI√ìN ==================== 
document.addEventListener('DOMContentLoaded', function() {
    initializeSalesChart();
    startLiveUpdates();
    initializeAnimations();
});

// ==================== GR√ÅFICO DE VENTAS ==================== 
function initializeSalesChart() {
    const ctx = document.getElementById('salesChart').getContext('2d');
    
    // Configuraci√≥n del gr√°fico
    salesChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ sales_labels|safe }},
            datasets: [{
                label: 'Ventas ($)',
                data: {{ sales_data|safe }},
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#667eea',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#667eea',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: false,
                    callbacks: {
                        title: function(context) {
                            return 'Ventas del ' + context[0].label;
                        },
                        label: function(context) {
                            return ' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return ' + value.toLocaleString();
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            elements: {
                point: {
                    hoverBackgroundColor: '#764ba2'
                }
            },
            animation: {
                duration: 2000,
                easing: 'easeInOutQuart'
            }
        }
    });
}

// ==================== CAMBIO DE PER√çODO DEL GR√ÅFICO ==================== 
function changeChartPeriod(period) {
    currentPeriod = period;
    
    // Actualizar botones
    document.querySelectorAll('.chart-period-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-purple-100', 'text-purple-700');
        btn.classList.add('text-gray-600', 'hover:bg-gray-100');
    });
    
    event.target.classList.remove('text-gray-600', 'hover:bg-gray-100');
    event.target.classList.add('active', 'bg-purple-100', 'text-purple-700');
    
    // Cargar nuevos datos
    fetch(`/dashboard/api/chart-data?type=sales&period=${period}`)
        .then(response => response.json())
        .then(data => {
            salesChart.data.labels = data.labels;
            salesChart.data.datasets[0].data = data.data;
            salesChart.update('active');
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
            showNotification('Error al cargar los datos del gr√°fico', 'error');
        });
}

// ==================== COPIAR URL DE TIENDA ==================== 
function copyStoreUrl() {
    const urlInput = document.getElementById('store-url');
    const copyBtn = document.getElementById('copy-btn');
    
    urlInput.select();
    urlInput.setSelectionRange(0, 99999); // Para m√≥viles
    
    navigator.clipboard.writeText(urlInput.value).then(() => {
        // Cambiar apariencia del bot√≥n
        copyBtn.innerHTML = '<i class="fas fa-check mr-2"></i>¬°Copiado!';
        copyBtn.classList.add('copied');
        
        // Volver al estado original despu√©s de 2 segundos
        setTimeout(() => {
            copyBtn.innerHTML = '<i class="fas fa-copy mr-2"></i>Copiar';
            copyBtn.classList.remove('copied');
        }, 2000);
        
        showNotification('URL copiada al portapapeles', 'success');
    }).catch(err => {
        console.error('Error copying URL:', err);
        showNotification('Error al copiar la URL', 'error');
    });
}

// ==================== ACTUALIZACIONES EN TIEMPO REAL ==================== 
function startLiveUpdates() {
    // Actualizar m√©tricas cada 2 minutos
    setInterval(updateLiveMetrics, 120000);
    
    // Primera actualizaci√≥n despu√©s de 10 segundos
    setTimeout(updateLiveMetrics, 10000);
}

function updateLiveMetrics() {
    fetch('/dashboard/api/live-metrics')
        .then(response => response.json())
        .then(data => {
            // Actualizar ventas de hoy
            const todaySalesElement = document.querySelector('[data-metric="today_sales"]');
            if (todaySalesElement && data.today_sales !== undefined) {
                animateNumber(todaySalesElement, parseFloat(todaySalesElement.textContent.replace(', '').replace(',', '')), data.today_sales);
            }
            
            // Actualizar pedidos de hoy
            const todayOrdersElement = document.querySelector('[data-metric="today_orders"]');
            if (todayOrdersElement && data.today_orders !== undefined) {
                animateNumber(todayOrdersElement, parseInt(todayOrdersElement.textContent), data.today_orders);
            }
            
            // Actualizar notificaciones de pedidos pendientes
            if (data.pending_orders !== undefined) {
                updatePendingOrdersBadges(data.pending_orders);
            }
            
            console.log('M√©tricas actualizadas:', data.timestamp);
        })
        .catch(error => {
            console.error('Error updating live metrics:', error);
        });
}

// ==================== ANIMACIONES ==================== 
function animateNumber(element, from, to, prefix = ') {
    const duration = 1000;
    const steps = 60;
    const stepValue = (to - from) / steps;
    const stepDuration = duration / steps;
    let current = from;
    
    const timer = setInterval(() => {
        current += stepValue;
        if ((stepValue > 0 && current >= to) || (stepValue < 0 && current <= to)) {
            current = to;
            clearInterval(timer);
        }
        
        const displayValue = prefix === ' ? 
            prefix + Math.round(current).toLocaleString() : 
            Math.round(current).toString();
            
        element.textContent = displayValue;
    }, stepDuration);
}

function initializeAnimations() {
    // Animar m√©tricas al cargar
    const metricNumbers = document.querySelectorAll('.metric-number');
    
    metricNumbers.forEach((element, index) => {
        setTimeout(() => {
            element.style.opacity = '0';
            element.style.transform = 'translateY(20px)';
            element.style.transition = 'all 0.6s ease';
            
            setTimeout(() => {
                element.style.opacity = '1';
                element.style.transform = 'translateY(0)';
            }, 100);
        }, index * 200);
    });
    
    // Animar cards al hacer scroll
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    });
    
    document.querySelectorAll('.metric-card').forEach(card => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        card.style.transition = 'all 0.6s ease';
        observer.observe(card);
    });
}

function updatePendingOrdersBadges(count) {
    const badges = document.querySelectorAll('.notification-badge');
    badges.forEach(badge => {
        if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    });
}

// ==================== NOTIFICACIONES ==================== 
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-4 rounded-lg text-white z-50 shadow-lg transition-all duration-300 ${
        type === 'error' ? 'bg-red-500' : 
        type === 'success' ? 'bg-green-500' : 
        type === 'warning' ? 'bg-yellow-500' :
        'bg-blue-500'
    }`;
    
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : type === 'warning' ? 'exclamation' : 'info'}-circle"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Animaci√≥n de entrada
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
        notification.style.opacity = '1';
    }, 100);
    
    // Remover despu√©s de 4 segundos
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        notification.style.opacity = '0';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 4000);
}

// ==================== ACCIONES R√ÅPIDAS ==================== 
function quickAction(action) {
    fetch('/dashboard/api/quick-actions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ action: action })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            // Actualizar m√©tricas si es necesario
            if (action === 'mark_all_delivered') {
                setTimeout(updateLiveMetrics, 1000);
            }
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error al ejecutar la acci√≥n', 'error');
    });
}

// ==================== FUNCIONES DE UTILIDAD ==================== 
function formatCurrency(amount) {
    return ' + amount.toLocaleString();
}

function formatNumber(number) {
    return number.toLocaleString();
}

// ==================== KEYBOARD SHORTCUTS ==================== 
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + N = Nuevo producto
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        window.location.href = '{{ url_for("dashboard.new_product") }}';
    }
    
    // Ctrl/Cmd + O = Ver pedidos
    if ((e.ctrlKey || e.metaKey) && e.key === 'o') {
        e.preventDefault();
        window.location.href = '{{ url_for("dashboard.orders") }}';
    }
    
    // Ctrl/Cmd + U = Copiar URL de tienda
    if ((e.ctrlKey || e.metaKey) && e.key === 'u') {
        e.preventDefault();
        copyStoreUrl();
    }
});

// ==================== MANEJO DE ERRORES GLOBAL ==================== 
window.addEventListener('error', function(e) {
    console.error('JavaScript Error:', e);
});

// ==================== MODO OFFLINE ==================== 
window.addEventListener('online', function() {
    showNotification('Conexi√≥n restaurada', 'success');
    updateLiveMetrics();
});

window.addEventListener('offline', function() {
    showNotification('Sin conexi√≥n a internet', 'warning');
});
</script>
{% endblock %}
